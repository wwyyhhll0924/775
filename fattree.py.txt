from mininet.topo import Topo
from mininet.net import Mininet
from mininet.cli import CLI
from mininet.link import TCLink
from mininet.log import setLogLevel

class FatTreeTopology(Topo):
    def __init__(self, k=4):
        Topo.__init__(self)

        # Add 4 Core switches
        core_switches = [self.addSwitch('Core-S{}'.format(i+1)) for i in range(k)]

        # Add 8 Aggregate switches
        agg_switches = [self.addSwitch('Agg-S{}'.format(i+1)) for i in range(2*k)]

        # Add 8 Edge switches
        edge_switches = [self.addSwitch('Edge-S{}'.format(i+1)) for i in range(2*k)]

        # Add 16 Hosts
        num_hosts = k * 4
        hosts = [self.addHost('h{}'.format(i+1)) for i in range(num_hosts)]

        # Connect core switches to aggregate switches
        for i in range(k):
            self.addLink(core_switches[i], agg_switches[2*i])
            self.addLink(core_switches[i], agg_switches[2*i+1])

        # Connect aggregate switches to edge switches
        for i in range(2*k):
            self.addLink(agg_switches[i], edge_switches[i])
            self.addLink(agg_switches[i], edge_switches[(i+1) % (2*k)])

        # Connect edge switches to hosts
        for i in range(num_hosts):
            self.addLink(edge_switches[i//2], hosts[i])

topos = {'fattreetopo': FatTreeTopology}

def run_fat_tree():
    topo = FatTreeTopology(k=4)
    net = Mininet(topo=topo, link=TCLink)
    net.start()
    CLI(net)
    net.stop()

if __name__ == '__main__':
    setLogLevel('info')
    run_fat_tree()
