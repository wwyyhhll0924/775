from mininet.topo import Topo
from mininet.net import Mininet
from mininet.cli import CLI
from mininet.link import TCLink
from mininet.log import setLogLevel

class FatTreeTopology(Topo):
    def __init__(self, k=4):
        Topo.__init__(self)

        # Add 4 Core switches
        core_switches = [self.addSwitch('Core-S{}'.format(i+1)) for i in range(k)]

        # Add 8 Aggregate switches
        agg_switches = [self.addSwitch('Agg-S{}'.format(i+1)) for i in range(2*k)]

        # Add 8 Edge switches
        edge_switches = [self.addSwitch('Edge-S{}'.format(i+1)) for i in range(2*k)]

        # Add 16 Hosts
        num_hosts = k * 4
        hosts = [self.addHost('h{}'.format(i+1)) for i in range(num_hosts)]

        # Connect core switches to aggregate switches
        for i in range(k):
            self.addLink(core_switches[i], agg_switches[2*i])
            self.addLink(core_switches[i], agg_switches[2*i+1])

        # Connect aggregate switches to edge switches
        for i in range(2*k):
            self.addLink(agg_switches[i], edge_switches[i])
            self.addLink(agg_switches[i], edge_switches[(i+1) % (2*k)])

        # Connect edge switches to hosts
        for i in range(num_hosts):
            self.addLink(edge_switches[i//2], hosts[i])

topos = {'fattreetopo': FatTreeTopology}

def run_fat_tree():
    topo = FatTreeTopology(k=4)
    net = Mininet(topo=topo, link=TCLink)
    net.start()
    CLI(net)
    net.stop()

if __name__ == '__main__':
    setLogLevel('info')
    run_fat_tree()



fvctl -n add-slice purple tcp:127.0.0.1:4000 admin@purple
fvctl -n add-slice blue tcp:127.0.0.1:5000 admin@blue
fvctl -n add-slice red tcp:127.0.0.1:6000 admin@red



# Purple Slice
# 核心交换机
fvctl -n add-flowspace purple_fs1 1 1 in_port=3,nw_src=10.0.0.3,nw_dst=10.0.0.4 purple=7
fvctl -n add-flowspace purple_fs2 1 1 in_port=4,nw_src=10.0.0.4,nw_dst=10.0.0.3 purple=7
fvctl -n add-flowspace purple_fs3 1 1 in_port=1,nw_src=10.0.0.5,nw_dst=10.0.0.4 purple=7
fvctl -n add-flowspace purple_fs4 1 1 in_port=1,nw_src=10.0.0.6,nw_dst=10.0.0.4 purple=7
fvctl -n add-flowspace purple_fs5 1 1 in_port=1,nw_src=10.0.0.5,nw_dst=10.0.0.3 purple=7
fvctl -n add-flowspace purple_fs6 1 1 in_port=1,nw_src=10.0.0.6,nw_dst=10.0.0.3 purple=7

# 聚合交换机
fvctl -n add-flowspace purple_fs7 2 1 in_port=4,nw_src=10.0.0.3,nw_dst=10.0.0.5 purple=7
fvctl -n add-flowspace purple_fs8 2 1 in_port=4,nw_src=10.0.0.3,nw_dst=10.0.0.6 purple=7
fvctl -n add-flowspace purple_fs9 2 1 in_port=4,nw_src=10.0.0.4,nw_dst=10.0.0.5 purple=7
fvctl -n add-flowspace purple_fs10 2 1 in_port=4,nw_src=10.0.0.4,nw_dst=10.0.0.6 purple=7
fvctl -n add-flowspace purple_fs11 2 1 in_port=1,nw_src=10.0.0.5,nw_dst=10.0.0.3 purple=7
fvctl -n add-flowspace purple_fs12 2 1 in_port=1,nw_src=10.0.0.5,nw_dst=10.0.0.4 purple=7
fvctl -n add-flowspace purple_fs13 2 1 in_port=1,nw_src=10.0.0.6,nw_dst=10.0.0.3 purple=7
fvctl -n add-flowspace purple_fs14 2 1 in_port=1,nw_src=10.0.0.6,nw_dst=10.0.0.4 purple=7

# 边缘交换机
fvctl -n add-flowspace purple_fs15 3 1 in_port=1,nw_src=10.0.0.3,nw_dst=10.0.0.5 purple=7
fvctl -n add-flowspace purple_fs16 3 1 in_port=1,nw_src=10.0.0.3,nw_dst=10.0.0.6 purple=7
fvctl -n add-flowspace purple_fs17 3 1 in_port=1,nw_src=10.0.0.4,nw_dst=10.0.0.5 purple=7
fvctl -n add-flowspace purple_fs18 3 1 in_port=1,nw_src=10.0.0.4,nw_dst=10.0.0.6 purple=7
fvctl -n add-flowspace purple_fs19 3 1 in_port=2,nw_src=10.0.0.5,nw_dst=10.0.0.3 purple=7
fvctl -n add-flowspace purple_fs20 3 1 in_port=2,nw_src=10.0.0.5,nw_dst=10.0.0.4 purple=7
fvctl -n add-flowspace purple_fs21 3 1 in_port=2,nw_src=10.0.0.6,nw_dst=10.0.0.3 purple=7
fvctl -n add-flowspace purple_fs22 3 1 in_port=2,nw_src=10.0.0.6,nw_dst=10.0.0.4 purple=7

